{% extends "base.html" %}
{% block title %}Zones d'Aparcament{% endblock %}

{% block content %}

<!--<div class="wrapper">-->
<div class="section" style="z-index: 2; position: relative;padding-top: 0px !important;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8">
        <div class="card" data-color="white">
          <div class="card-body">
            <div class="form-group">
              <div class="col-12 btn-disabled titols">Zones de Pagament</div>
            </div>
            <div id="map" class="rounded" style="height: 500px; width: 100%;  border: 2px #94b9ff solid; "></div>
            <div class="mt-3 form-group">
              <a id="nova_zona" href="" class="col-12 btn btn-neutral btn-round">Nova Zona</a>
            </div>
            <div id="nova_zona_form" style="display: none;">
              <div class="col-12">
                <p class="text-center">Dibuixa un polígon al mapa per definir la zona d'aparcament.</p>
              </div>
              <form method="post" id="form_guardar_zona" action="/guardar-zona" class="pr-4 pl-4 mt-4">
                <div class="form-group">
                  <label for="tipus" class="font-weight-bold d-block" style="color:#66615b;">Selecciona Tipus de
                    Zona:</label>
                  <select name="tipus" class="form-control select-class"
                    style="border-radius: 30px; border: 3px solid #94b9ff;" id="tipus">
                    <option value="blava">Blava</option>
                    <option value="taronja">Taronja</option>
                    <option value="verda">Verda</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="temps_Maxim" class="font-weight-bold d-block" style="color:#66615b;">Temps maxim: (sino
                    0)</label>
                  <input type="number" class="form-control input-class" id="temps_Maxim" min="0" max="240"
                    placeholder="0" name="temps_Maxim">
                </div>
                <div class="form-group">
                  <label for="preu_Min" class="font-weight-bold d-block" style="color:#66615b;">Preu de la Zona:
                  </label>
                  <input type="number" class="form-control input-class" id="preu_Min" min="0.05" step="0.01"
                    placeholder="1" name="preu_Min">
                </div>
                <div class="form-group">
                  <label for="ciutat" class="font-weight-bold d-block" style="color:#66615b;">Ciutat: </label>
                  <input type="text" class="form-control input-class" id="ciutat" name="ciutat" dissabled
                    style="background-color: #f8f9fa;">
                </div>
                <div class="form-group">
                  <label for="carrer" class="font-weight-bold d-block" style="color:#66615b;">Carrer: </label>
                  <input type="text" class="form-control input-class" id="carrer" name="carrer">
                </div>
                <div class="form-group">
                  <label>Coordenades:</label>
                  <textarea id="coords" name="coords" class="form-control" rows="5"
                    style="border-radius: 30px; border: 3px solid #94b9ff;" readonly></textarea>
                </div>
                <div class="form-group">
                  <button type="submit" class="col-12 m-auto btn btn-green btn-round">Guardar zona</button>
                </div>
              </form>
            </div>
            <div class="mt-3 form-group">
              <a id="editar_zona" href="" class="col-12 btn btn-neutral btn-round">Editar Zona</a>
            </div>
            <div id="editar_zona_form" style="display: none;">
              <div class="col-12">
                <p class="text-center">Ara ja pots editar la zona seleecionada</p>
              </div>
              <form method="post" id="form_editar_zona" action="/editar-zona" class="pr-4 pl-4 mt-4">
                <div class="form-group">
                  <label for="tipus" class="font-weight-bold d-block" style="color:#66615b;">Selecciona Tipus de
                    Zona:</label>
                  <select name="tipus" class="form-control select-class"
                    style="border-radius: 30px; border: 3px solid #94b9ff;" id="tipus">
                    <option value="blava">Blava</option>
                    <option value="taronja">Taronja</option>
                    <option value="verda">Verda</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="temps_Maxim" class="font-weight-bold d-block" style="color:#66615b;">Temps maxim: (sino
                    0)</label>
                  <input type="number" class="form-control input-class" id="temps_Maxim" min="0" max="240"
                    placeholder="0" name="temps_Maxim">
                </div>
                <div class="form-group">
                  <label for="preu_Min" class="font-weight-bold d-block" style="color:#66615b;">Preu de la Zona:
                  </label>
                  <input type="number" class="form-control input-class" id="preu_Min" min="0.05" step="0.01"
                    placeholder="1" name="preu_Min">
                </div>
                <div class="form-group">
                  <label for="ciutat" class="font-weight-bold d-block" style="color:#66615b;">Ciutat: </label>
                  <input type="text" class="form-control input-class" id="ciutat" name="ciutat" dissabled
                    style="background-color: #f8f9fa;">
                </div>
                <div class="form-group">
                  <label for="carrer" class="font-weight-bold d-block" style="color:#66615b;">Carrer: </label>
                  <input type="text" class="form-control input-class" id="carrer" name="carrer">
                </div>
                <div class="form-group">
                  <label>Coordenades:</label>
                  <textarea id="coords" name="coords" class="form-control" rows="5"
                    style="border-radius: 30px; border: 3px solid #94b9ff;" readonly></textarea>
                </div>
                <div class="form-group">
                  <button type="submit" class="col-12 m-auto btn btn-green btn-round">Guardar edicio zona</button>
                </div>
              </form>
            </div>
            <div class="mt-3 form-group">
              <a id="eliminar_zona href="" class=" col-12 btn btn-neutral btn-round">Eliminar Zona</a>
            </div>
            <div id="eliminar_zona_form" style=" display: none;">
              <div class="col-12">
                <p class="text-center">-----------</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block scripts %}

<script>
  let map;
  let drawingManager;
  let selectedShape;


  document.getElementById("form_guardar_zona").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    try {
      const response = await fetch("/guardar-zona", {
        method: "POST",
        body: formData
      });

      if (!response.ok) {
        throw new Error("Error al guardar la zona");
      }

      const result = await response.json();
      alert("Zona guardada correctament!");

      // reinicia el formulari
      form.reset();
      document.getElementById("coords").value = "";

      // dibuixa la nova zona al mapa
      const zona = result.zona; 
      const polygonCoords = JSON.parse(zona.coordenades).map(coord => ({ lat: coord.lat, lng: coord.lng }));
      const color = zona.tipus === "blava" ? "#009cff" :
        zona.tipus === "verda" ? "#00FF00" :
          zona.tipus === "taronja" ? "#FFA500" : "#FF0000";

      const polygon = new google.maps.Polygon({
        paths: polygonCoords,
        strokeColor: color,
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: color,
        fillOpacity: 0.35
      });

      polygon.setMap(map);

      const infoWindow = new google.maps.InfoWindow();
      polygon.addListener('click', (event) => {
        // si ja hi ha un seleccionat, desactiva edició i restaura estil
        if (selectedShape) {
          selectedShape.setEditable(false);
          selectedShape.setDraggable(false);
          selectedShape.setOptions({ strokeWeight: 2 });  // gruix normal
        }

        // marca nou seleccionat
        selectedShape = polygon;
        selectedShape.setOptions({ strokeWeight: 4 });  // gruix més gran

        // mostrar info
        const infoWindow = new google.maps.InfoWindow();
        infoWindow.setContent(
          `<strong>Zona ${zona.tipus}</strong><br>
         Carrer: ${zona.carrer}<br>
         Preu mínim: ${zona.preu_min} €<br>
         Temps màxim: ${zona.temps_maxim} min`
        );
        infoWindow.setPosition(event.latLng);
        infoWindow.open(map);
      });


      if (selectedShape) {
        selectedShape.setEditable(false);
        selectedShape.setDraggable(false);
      }

      drawingManager.setDrawingMode(null);
      const nova_zona_form = document.getElementById('nova_zona_form');
      const eliminar_zona_form = document.getElementById('eliminar_zona_form');
      const canviar_zona_form = document.getElementById('canviar_zona_form');

      nova_zona_form.style.display = 'none';
      eliminar_zona_form.style.display = 'none';
      canviar_zona_form.style.display = 'none';

    } catch (error) {
      console.error("Error:", error);
      alert("Hi ha hagut un error al guardar la zona.");
    }
  });

  document.getElementById("editar_zona").addEventListener("click", function (e) {
    e.preventDefault();
    if (selectedShape) {
      selectedShape.setEditable(true);
      selectedShape.setDraggable(true);
      google.maps.event.addListener(selectedShape.getPath(), 'set_at', updateCoords);
      google.maps.event.addListener(selectedShape.getPath(), 'insert_at', updateCoords);
    } else {
      alert("No hi ha cap zona seleccionada!");
    }
  });

  document.getElementById("form_editar_zona").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    try {
      const response = await fetch("/guardar-zona", {
        method: "POST",
        body: formData
      });

      if (!response.ok) {
        throw new Error("Error al guardar la zona");
      }

      const result = await response.json();
      alert("Zona guardada correctament!");

      form.reset();
      document.getElementById("coords").value = "";

      const zona = result.zona;  
      const polygonCoords = JSON.parse(zona.coordenades).map(coord => ({ lat: coord.lat, lng: coord.lng }));
      const color = zona.tipus === "blava" ? "#009cff" :
        zona.tipus === "verda" ? "#00FF00" :
          zona.tipus === "taronja" ? "#FFA500" : "#FF0000";

      const polygon = new google.maps.Polygon({
        paths: polygonCoords,
        strokeColor: color,
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: color,
        fillOpacity: 0.35
      });

      polygon.setMap(map);

      const infoWindow = new google.maps.InfoWindow();
      polygon.addListener('click', (event) => {
        if (selectedShape) {
          selectedShape.setEditable(false);
          selectedShape.setDraggable(false);
          selectedShape.setOptions({ strokeWeight: 2 }); 
        }
        selectedShape = polygon;
        selectedShape.setOptions({ strokeWeight: 4 }); 

        const infoWindow = new google.maps.InfoWindow();
        infoWindow.setContent(
          `<strong>Zona ${zona.tipus}</strong><br>
         Carrer: ${zona.carrer}<br>
         Preu mínim: ${zona.preu_min} €<br>
         Temps màxim: ${zona.temps_maxim} min`
        );
        infoWindow.setPosition(event.latLng);
        infoWindow.open(map);
      });


      if (selectedShape) {
        selectedShape.setEditable(false);
        selectedShape.setDraggable(false);
      }

      drawingManager.setDrawingMode(null);
      const nova_zona_form = document.getElementById('nova_zona_form');
      const eliminar_zona_form = document.getElementById('eliminar_zona_form');
      const canviar_zona_form = document.getElementById('canviar_zona_form');

      nova_zona_form.style.display = 'none';
      eliminar_zona_form.style.display = 'none';
      canviar_zona_form.style.display = 'none';

    } catch (error) {
      console.error("Error:", error);
      alert("Hi ha hagut un error al guardar la zona.");
    }
  });


  document.getElementById('nova_zona').addEventListener('click', function (e) {
    e.preventDefault();

    const nova_zona_form = document.getElementById('nova_zona_form');
    const eliminar_zona_form = document.getElementById('eliminar_zona_form');
    const canviar_zona_form = document.getElementById('editar_zona_form');

    drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);

    // formulari de nova zona
    nova_zona_form.style.display = 'block';
    eliminar_zona_form.style.display = 'none';
    canviar_zona_form.style.display = 'none';
  });

  document.getElementById('eliminar_zona').addEventListener('click', function (e) {
    e.preventDefault();

    const nova_zona_form = document.getElementById('nova_zona_form');
    const eliminar_zona_form = document.getElementById('editar_zona_form');
    const canviar_zona_form = document.getElementById('editar_zona_form');

    if (selectedShape) {
      selectedShape.setMap(null);
      selectedShape = null;
      document.getElementById("coords").value = "";
    }
    // formulari d'eliminació de zona
    nova_zona_form.style.display = 'none';
    eliminar_zona_form.style.display = 'block';
    canviar_zona_form.style.display = 'none';
  });

  document.getElementById('editar_zona').addEventListener('click', function (e) {
    e.preventDefault();

    const nova_zona_form = document.getElementById('nova_zona_form');
    const eliminar_zona_form = document.getElementById('eliminar_zona_form');
    const canviar_zona_form = document.getElementById('editar_zona_form');

    if (selectedShape) {
      selectedShape.setEditable(true);
      selectedShape.setDraggable(true);
      google.maps.event.addListener(selectedShape.getPath(), 'set_at', updateCoords);
      google.maps.event.addListener(selectedShape.getPath(), 'insert_at', updateCoords);
    }
    
    // formulari de canvi de zona
    nova_zona_form.style.display = 'none';
    eliminar_zona_form.style.display = 'none';
    canviar_zona_form.style.display = 'block';
  });

  function initMap() {
    const geocoder = new google.maps.Geocoder();
    const ciutat = "{{ user.ciutat }}";
    document.getElementById("ciutat").value = ciutat;

    geocoder.geocode({ address: ciutat }, function (results, status) {
      if (status === "OK") {
        const centre = results[0].geometry.location;
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 14,
          center: centre,
        });

        drawingManager = new google.maps.drawing.DrawingManager({
          drawingMode: null,
          drawingControl: false,
          polygonOptions: { editable: true, draggable: true },
        });
        drawingManager.setMap(map);

        google.maps.event.addListener(drawingManager, 'overlaycomplete', function (event) {
          if (selectedShape) selectedShape.setMap(null);
          selectedShape = event.overlay;
          updateCoords();
        });

        // crida al backend per carregar les zones existents
        fetch(`/obtenir-zones?ciutat=${encodeURIComponent(ciutat)}`)
          .then(response => response.json())
          .then(zones => {
            zones.forEach(zona => {
              const polygonCoords = zona.coordenades.map(coord => ({ lat: coord.lat, lng: coord.lng }));
              const color = zona.tipus === "blava" ? "#009cff" :
                zona.tipus === "verda" ? "#00FF00" :
                  zona.tipus === "taronja" ? "#FFA500" : "#FF0000";

              const polygon = new google.maps.Polygon({
                paths: polygonCoords,
                strokeColor: color,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: color,
                fillOpacity: 0.35
              });

              polygon.setMap(map);

              const infoWindow = new google.maps.InfoWindow();
              polygon.addListener('click', (event) => {
                if (selectedShape) {
                  selectedShape.setEditable(false);
                  selectedShape.setDraggable(false);
                  selectedShape.setOptions({ strokeWeight: 2 });  
                }
                selectedShape = polygon;
                selectedShape.setOptions({ strokeWeight: 4 });  

                const infoWindow = new google.maps.InfoWindow();
                infoWindow.setContent(
                  `<strong>Zona ${zona.tipus}</strong><br>
         Carrer: ${zona.carrer}<br>
         Preu mínim: ${zona.preu_min} €<br>
         Temps màxim: ${zona.temps_maxim} min`
                );
                infoWindow.setPosition(event.latLng);
                infoWindow.open(map);
              });


            });
          })
          .catch(error => {
            console.error("Error carregant zones:", error);
          });
      } else {
        alert("No s'ha pogut trobar la ciutat: " + status);
      }
    });
  }


  function updateCoords() {
    if (selectedShape) {
      const path = selectedShape.getPath().getArray();
      const coords = path.map(coord => ({
        lat: coord.lat(),
        lng: coord.lng()
      }));
      document.getElementById("coords").value = JSON.stringify(coords, null, 2);
    }
  }

</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=initMap&libraries=drawing">
  </script>

{% endblock %}